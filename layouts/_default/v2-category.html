{{ define "main" }}
{{ $categoryName := .Params.category }}
{{ $allPages := where .Site.RegularPages "Type" "posts" }}
{{ $categoryPages := where $allPages "Params.categories" "intersect" (slice $categoryName) }}
{{ $totalArticles := len $categoryPages }}

<div class="category-page">

  {{/* 分類標題區 */}}
  <header class="category-page__header">
    <h1 class="category-page__title">{{ $categoryName }}</h1>
    <p class="category-page__count">共 {{ $totalArticles }} 篇文章</p>
  </header>

  {{/* ============================================ */}}
  {{/* 第一排：3 篇有圖文章 */}}
  {{/* ============================================ */}}
  {{ if ge $totalArticles 1 }}
  <section class="category-page__row category-page__row--3col">
    {{ range $categoryPages | first 3 }}
      {{ partial "v2/article-card.html" (dict "page" . "variant" "default") }}
    {{ end }}
  </section>
  {{ end }}

  {{/* ============================================ */}}
  {{/* 第二排：4 篇有圖文章 */}}
  {{/* ============================================ */}}
  {{ if gt $totalArticles 3 }}
  <section class="category-page__row category-page__row--4col">
    {{ range $categoryPages | first 7 | after 3 }}
      {{ partial "v2/article-card.html" (dict "page" . "variant" "default") }}
    {{ end }}
  </section>
  {{ end }}

  {{/* ============================================ */}}
  {{/* 第三～五排：每排 4 篇純文字（標題 + 摘要） */}}
  {{/* ============================================ */}}
  {{ if gt $totalArticles 7 }}
  {{ $textPages := $categoryPages | after 7 }}
  {{ $textRows := slice (slice 0 4) (slice 4 8) (slice 8 12) }}

  {{ range $row := $textRows }}
    {{ $start := index $row 0 }}
    {{ $end := index $row 1 }}
    {{ $rowPages := slice }}

    {{/* 手動取出 start~end 範圍的文章 */}}
    {{ range $i, $p := $textPages }}
      {{ if and (ge $i $start) (lt $i $end) }}
        {{ $rowPages = $rowPages | append $p }}
      {{ end }}
    {{ end }}

    {{ if gt (len $rowPages) 0 }}
    <section class="category-page__row category-page__row--text">
      {{ range $rowPages }}
      <article class="category-page__text-item">
        <a href="{{ .Permalink }}" class="text-item">
          <h3 class="text-item__title">{{ .Title }}</h3>
          <p class="text-item__excerpt">
            {{ with .Description }}
              {{ . | truncate 100 }}
            {{ else }}
              {{ .Summary | plainify | truncate 100 }}
            {{ end }}
          </p>
          <div class="text-item__meta">
            <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "2006.01.02" }}</time>
            {{ with .Params.source_name }}
            <span class="text-item__source">· {{ . }}</span>
            {{ end }}
          </div>
        </a>
      </article>
      {{ end }}
    </section>
    {{ end }}
  {{ end }}
  {{ end }}

  {{/* ============================================ */}}
  {{/* 更多文章（第 19 篇之後）：緊湊列表 */}}
  {{/* ============================================ */}}
  {{ if gt $totalArticles 19 }}
  <section class="category-page__more">
    <h2 class="category-page__more-title">更多文章</h2>
    <div class="category-page__list">
      {{ range $categoryPages | after 19 }}
      <article class="category-page__list-item">
        <a href="{{ .Permalink }}" class="list-item">
          <div class="list-item__body">
            <h3 class="list-item__title">{{ .Title }}</h3>
            <div class="list-item__meta">
              <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "2006.01.02" }}</time>
              {{ with .Params.source_name }}
              <span class="list-item__source">{{ . }}</span>
              {{ end }}
            </div>
          </div>
        </a>
      </article>
      {{ end }}
    </div>
  </section>
  {{ end }}

</div>
{{ end }}
