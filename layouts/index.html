{{/*
  AINEXT V2 - 首頁

  去重規則：
  1. Hero 區塊 4 篇：source_url 不得重複
  2. 今日焦點 6 篇：不與 Hero 區塊重複
  3. 每個分類 4 篇：source_url 不得重複
*/}}

{{ define "main" }}

{{ $allPages := where .Site.RegularPages "Type" "posts" }}

{{/* ========== Hero 區塊：先選出不重複 source_url 的 4 篇有圖文章 ========== */}}
{{ $heroPages := slice }}
{{ $usedSourceURLs := slice }}

{{ range $allPages }}
  {{ if lt (len $heroPages) 4 }}
    {{ $sourceURL := .Params.source_url | default "" }}
    {{/* 如果沒有 source_url 或 source_url 尚未使用，就加入 */}}
    {{ if or (eq $sourceURL "") (not (in $usedSourceURLs $sourceURL)) }}
      {{ $heroPages = $heroPages | append . }}
      {{ if ne $sourceURL "" }}
        {{ $usedSourceURLs = $usedSourceURLs | append $sourceURL }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* ========== 今日焦點 6 篇：排除已在 heroPages 的文章 ========== */}}
{{ $glancePages := slice }}
{{ $heroPagePaths := slice }}
{{ range $heroPages }}
  {{ $heroPagePaths = $heroPagePaths | append .File.Path }}
{{ end }}

{{ range $allPages }}
  {{ if lt (len $glancePages) 6 }}
    {{ if not (in $heroPagePaths .File.Path) }}
      {{ $glancePages = $glancePages | append . }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* 定義分類名稱到英文 slug URL 的對應 */}}
{{ $categoryURLs := dict
  "AI 技術前沿" "/categories/ai-tech/"
  "AI 產業動態" "/categories/ai-industry/"
  "AI 開發實戰" "/categories/ai-dev/"
  "AI 安全與治理" "/categories/ai-safety/"
  "科技巨頭觀察" "/categories/tech-giants/"
  "地緣政治與經濟" "/categories/geopolitics/"
  "領袖思維" "/categories/leadership/"
  "職涯與學習" "/categories/career/"
}}

<div class="homepage">

  {{/* Hero 區塊 */}}
  <section class="hero-section">
    <div class="hero-section__glance">
      <h2 class="glance-title">今日焦點</h2>
      <p class="glance-updated">更新於 {{ now.Format "15:04" }}</p>
      <ol class="headlines-list">
        {{ range $i, $page := $glancePages }}
        <li class="headlines-list__item">
          <span class="headlines-list__number">{{ add $i 1 }}</span>
          <div class="headlines-list__content">
            {{ with $page.Params.categories }}
              {{ range first 1 . }}
              <span class="headlines-list__category">{{ . }}</span>
              {{ end }}
            {{ end }}
            <a href="{{ $page.Permalink }}">{{ $page.Title }}</a>
          </div>
        </li>
        {{ end }}
      </ol>
    </div>

    <div class="hero-section__main">
      {{ with index $heroPages 0 }}
        {{ partial "v2/article-card.html" (dict "page" . "variant" "hero") }}
      {{ end }}
    </div>

    <div class="hero-section__sidebar">
      {{ range $heroPages | after 1 }}
        {{ partial "v2/article-card.html" (dict "page" . "variant" "small") }}
      {{ end }}
    </div>
  </section>

  {{/* ========== 分類區塊 - 按分類動態顯示，每類去重 source_url ========== */}}
  {{ $catIdx := 0 }}
  {{ range .Site.Taxonomies.categories }}
    {{ $categoryName := .Page.Title }}
    {{ $categoryPages := .Pages }}
    {{ $categoryURL := index $categoryURLs $categoryName | default .Page.Permalink }}

    {{/* 從該分類中選出 source_url 不重複的文章（最多 4 篇） */}}
    {{ $uniquePages := slice }}
    {{ $catUsedURLs := slice }}

    {{ range $categoryPages }}
      {{ if lt (len $uniquePages) 4 }}
        {{ $srcURL := .Params.source_url | default "" }}
        {{ if or (eq $srcURL "") (not (in $catUsedURLs $srcURL)) }}
          {{ $uniquePages = $uniquePages | append . }}
          {{ if ne $srcURL "" }}
            {{ $catUsedURLs = $catUsedURLs | append $srcURL }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}

    {{ if gt (len $uniquePages) 0 }}
    <section class="category-section">
      <div class="category-section__header">
        <h2 class="category-title">
          <a href="{{ $categoryURL }}">{{ $categoryName }}</a>
        </h2>
      </div>

      {{ if eq (mod $catIdx 2) 0 }}
      <div class="category-layout--b">
        {{ range $uniquePages }}
          {{ partial "v2/article-card.html" (dict "page" . "variant" "default") }}
        {{ end }}
      </div>
      {{ else }}
      <div class="category-layout--c">
        {{ range $uniquePages | first 3 }}
          {{ partial "v2/article-card.html" (dict "page" . "variant" "default") }}
        {{ end }}
      </div>
      {{ end }}
    </section>
    {{ $catIdx = add $catIdx 1 }}
    {{ end }}
  {{ end }}

  {{/* ========== 公司庫精選 ========== */}}
  {{ $allCompanies := where .Site.RegularPages "Section" "companies" }}
  {{ if gt (len $allCompanies) 0 }}
  <section class="directory-section" id="section-companies">
    <div class="directory-section__header">
      <h2 class="directory-section__title">
        <a href="{{ "/companies/" | relURL }}">公司庫</a>
      </h2>
      <p class="directory-section__desc">收錄 {{ len $allCompanies }} 家 AI 產業重要公司</p>
      <a href="{{ "/companies/" | relURL }}" class="directory-section__more">瀏覽全部 →</a>
    </div>

    <div class="directory-section__grid">
      {{ range $allCompanies | first 6 }}
        {{ partial "v2/company-card.html" (dict "company" . "variant" "small") }}
      {{ end }}
    </div>
  </section>
  {{ end }}

  {{/* ========== 人物庫精選 ========== */}}
  {{ $allPeople := where .Site.RegularPages "Section" "people" }}
  {{ if gt (len $allPeople) 0 }}
  <section class="directory-section" id="section-people">
    <div class="directory-section__header">
      <h2 class="directory-section__title">
        <a href="{{ "/people/" | relURL }}">人物庫</a>
      </h2>
      <p class="directory-section__desc">收錄 {{ len $allPeople }} 位 AI 領域重要人物</p>
      <a href="{{ "/people/" | relURL }}" class="directory-section__more">瀏覽全部 →</a>
    </div>

    <div class="directory-section__grid directory-section__grid--people">
      {{ range $allPeople | first 6 }}
        {{ partial "v2/person-card.html" (dict "person" . "variant" "small") }}
      {{ end }}
    </div>
  </section>
  {{ end }}

</div>
{{ end }}
