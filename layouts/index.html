{{ define "main" }}
{{- $config := site.Params }}
{{- $blog_dir := default "posts" $config.blogDir }}
{{- $allPages := where site.RegularPages "Type" "in" $config.mainSections }}

{{/* 過濾同 source_url 的重複文章，只保留最新一篇 */}}
{{- $seenSources := slice }}
{{- $filteredPages := slice }}
{{- range $allPages }}
  {{- $sourceID := "" }}
  {{- with .Params.source_url }}
    {{/* 從 YouTube URL 提取 video ID */}}
    {{- if findRE "youtube\\.com|youtu\\.be" . }}
      {{- if findRE "v=([a-zA-Z0-9_-]+)" . }}
        {{- $sourceID = replaceRE ".*v=([a-zA-Z0-9_-]+).*" "$1" . }}
      {{- else if findRE "youtu\\.be/([a-zA-Z0-9_-]+)" . }}
        {{- $sourceID = replaceRE ".*youtu\\.be/([a-zA-Z0-9_-]+).*" "$1" . }}
      {{- end }}
    {{/* 從 Spotify URL 提取 episode ID */}}
    {{- else if findRE "spotify\\.com" . }}
      {{- if findRE "episode/([a-zA-Z0-9]+)" . }}
        {{- $sourceID = replaceRE ".*episode/([a-zA-Z0-9]+).*" "$1" . }}
      {{- end }}
    {{/* 其他 URL 使用完整 URL 作為 ID */}}
    {{- else }}
      {{- $sourceID = . }}
    {{- end }}
  {{- end }}

  {{/* 如果沒有 source_url 或是新的 source，加入列表 */}}
  {{- if eq $sourceID "" }}
    {{- $filteredPages = $filteredPages | append . }}
  {{- else if not (in $seenSources $sourceID) }}
    {{- $seenSources = $seenSources | append $sourceID }}
    {{- $filteredPages = $filteredPages | append . }}
  {{- end }}
{{- end }}

<div class="wrap pt-2 mt-2">
  {{- $paginator := .Paginate $filteredPages -}}
  {{- $size := $paginator.PagerSize }}
  {{- $scratch := newScratch }}
  {{- range $index, $value := $paginator.Pages }}
  {{ $bg := partial "func/getImage" . }}
  <article class="article mb-2">
    <a href={{ $value.Permalink }} {{ if eq $index 0 }} class=grid-reverse {{ end }}>
      <div class=article_thumb style='background-image: url({{ $bg }})'></div>
      <div class="article_meta {{ if eq $index 0 }} center_y {{ end }}">
        <time class="post_date">{{ dateFormat "January 02, 2006" $value.Date }}</time>
        <h3 class="article_title">{{ $value.Title }}</h3>
        <div class="article_excerpt {{ if eq $index 0 }} visible {{ end }}">
          {{/* 優先使用 description，避免 Summary 包含 iframe 等 HTML 被截斷 */}}
          {{ if $value.Description }}
            <p>{{ $value.Description }}</p>
          {{ else }}
            <p>{{ $value.Summary | plainify | truncate 150 }}</p>
          {{ end }}
        </div>
      </div>
    </a>
  </article>
  {{- if and (eq $index 0) (gt $size 1) }}<div class="grid-2 article_showcase">{{ end }}
    {{- if and (eq $index (add $size -1)) (gt $size 1) }}</div>{{ end }}
  {{- end }}
</div>
<a href='{{ absURL (printf "%s/%s" $blog_dir "") }}' class=post_nav><span class=post_next>{{ T "archive_text" }}
    <svg class="icon icon_scale">
      <use xlink:href="#double-arrow"></use>
    </svg>
  </span></a>
{{ end }}
