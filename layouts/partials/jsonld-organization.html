{{- $schema := dict
  "@context" "https://schema.org"
  "@type" "Organization"
  "name" .Title
  "url" (.Params.website | default .Permalink)
-}}

{{- with .Params.description_short -}}
  {{- $schema = merge $schema (dict "description" .) -}}
{{- end -}}

{{- with .Params.name_zh -}}
  {{- $schema = merge $schema (dict "alternateName" .) -}}
{{- end -}}

{{- with .Params.logo -}}
  {{- $schema = merge $schema (dict "logo" (. | absURL)) -}}
{{- end -}}

{{- with .Params.founded -}}
  {{- $schema = merge $schema (dict "foundingDate" (printf "%v" .)) -}}
{{- end -}}

{{- with .Params.employee_count -}}
  {{- $schema = merge $schema (dict "numberOfEmployees" (dict "@type" "QuantitativeValue" "value" (printf "%v" .))) -}}
{{- end -}}

{{- /* 中文國名 → ISO 3166-1 alpha-2 國碼對照 */ -}}
{{- $countryCodeMap := dict
  "美國" "US" "中國" "CN" "英國" "GB" "法國" "FR" "德國" "DE"
  "加拿大" "CA" "以色列" "IL" "印度" "IN" "新加坡" "SG" "瑞典" "SE"
  "南韓" "KR" "韓國" "KR" "日本" "JP" "瑞士" "CH" "沙烏地阿拉伯" "SA"
  "澳洲" "AU" "荷蘭" "NL" "挪威" "NO" "阿聯酋" "AE" "葡萄牙" "PT"
  "愛爾蘭" "IE" "愛沙尼亞" "EE" "開曼群島" "KY" "智利" "CL"
  "芬蘭" "FI" "西班牙" "ES" "百慕達" "BM" "比利時" "BE"
  "香港" "HK" "台灣" "TW" "巴西" "BR" "義大利" "IT" "波蘭" "PL"
-}}

{{- /* 地址：city 或 country 有值才加入 */ -}}
{{- if or .Params.city .Params.country -}}
  {{- $addr := dict "@type" "PostalAddress" -}}
  {{- with .Params.city -}}
    {{- $addr = merge $addr (dict "addressLocality" .) -}}
  {{- end -}}
  {{- with .Params.country -}}
    {{- /* 嘗試精確匹配，再嘗試前綴匹配（處理「美國（紐約）」等帶括號的值） */ -}}
    {{- $raw := . -}}
    {{- $code := index $countryCodeMap $raw -}}
    {{- if not $code -}}
      {{- /* 取括號前的部分做前綴匹配 */ -}}
      {{- $base := index (split $raw "（") 0 -}}
      {{- $base = index (split $base "/") 0 -}}
      {{- $code = index $countryCodeMap $base -}}
    {{- end -}}
    {{- if $code -}}
      {{- $addr = merge $addr (dict "addressCountry" $code) -}}
    {{- else -}}
      {{- $addr = merge $addr (dict "addressCountry" $raw) -}}
    {{- end -}}
  {{- end -}}
  {{- $schema = merge $schema (dict "address" $addr) -}}
{{- end -}}

{{- /* sameAs：收集所有非空社群連結 */ -}}
{{- $sameAs := slice -}}
{{- with .Params.social -}}
  {{- with .twitter -}}{{- $sameAs = $sameAs | append . -}}{{- end -}}
  {{- with .linkedin -}}{{- $sameAs = $sameAs | append . -}}{{- end -}}
  {{- with .github -}}{{- $sameAs = $sameAs | append . -}}{{- end -}}
  {{- with .crunchbase -}}{{- $sameAs = $sameAs | append . -}}{{- end -}}
  {{- with .wikipedia -}}{{- $sameAs = $sameAs | append . -}}{{- end -}}
  {{- with .investor_relations -}}{{- $sameAs = $sameAs | append . -}}{{- end -}}
{{- end -}}
{{- if gt (len $sameAs) 0 -}}
  {{- $schema = merge $schema (dict "sameAs" $sameAs) -}}
{{- end -}}

{{ printf `<script type="application/ld+json">%s</script>` ($schema | jsonify (dict "indent" "  ")) | safeHTML }}
