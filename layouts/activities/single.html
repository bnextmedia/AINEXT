{{ define "main" }}
<article class="activity-detail">

  {{/* è¿”å›æŒ‰éˆ• */}}
  <nav class="activity-detail__nav">
    <a href="/activities/" class="activity-detail__back">&larr; è¿”å›æ´»å‹•åˆ—è¡¨</a>
  </nav>

  {{/* æ´»å‹•ä»£è¡¨åœ– */}}
  {{ with .Params.image }}
  <div class="activity-detail__hero">
    <img src="{{ . }}" alt="{{ $.Title }}" class="activity-detail__hero-img">
    {{/* å·²çµæŸæ¨™ç±¤ */}}
    {{ $today := now.Format "2006-01-02" }}
    {{ if lt $.Params.date_end $today }}
    <span class="activity-detail__badge activity-detail__badge--past">å·²çµæŸ</span>
    {{ end }}
  </div>
  {{ end }}

  {{/* æ´»å‹•æ¨™é¡Œ */}}
  <header class="activity-detail__header">
    {{/* æ´»å‹•é¡å‹æ¨™ç±¤ */}}
    {{ with .Params.activity_type }}
    <span class="activity-detail__type activity-detail__type--{{ . }}">
      {{ if eq . "conference" }}ç ”è¨æœƒ
      {{ else if eq . "expo" }}å±•è¦½
      {{ else if eq . "workshop" }}å·¥ä½œåŠ
      {{ else if eq . "meetup" }}ç¤¾ç¾¤èšæœƒ
      {{ else if eq . "hackathon" }}é»‘å®¢æ¾
      {{ else if eq . "webinar" }}ç·šä¸Šç ”è¨æœƒ
      {{ else if eq . "course" }}èª²ç¨‹
      {{ else if eq . "competition" }}ç«¶è³½
      {{ else }}{{ . }}
      {{ end }}
    </span>
    {{ end }}

    <h1 class="activity-detail__title">{{ .Title }}</h1>

    {{ with .Params.description_short }}
    <p class="activity-detail__excerpt">{{ . }}</p>
    {{ end }}
  </header>

  {{/* æ´»å‹•è³‡è¨Šå¡ç‰‡ */}}
  <div class="activity-detail__info-cards">

    {{/* æ™‚é–“å¡ç‰‡ */}}
    <div class="activity-detail__card">
      <div class="activity-detail__card-icon">ğŸ“…</div>
      <div class="activity-detail__card-content">
        <h3 class="activity-detail__card-title">æ´»å‹•æ™‚é–“</h3>
        <p class="activity-detail__card-text">
          {{ if eq .Params.date_start .Params.date_end }}
            {{ .Params.date_start }}
          {{ else }}
            {{ .Params.date_start }} ~ {{ .Params.date_end }}
          {{ end }}
        </p>
        {{ with .Params.time_info }}
        <p class="activity-detail__card-sub">{{ . }}</p>
        {{ end }}

        {{/* åŠ å…¥æ—¥æ›†æŒ‰éˆ• */}}
        <div class="activity-detail__calendar-btns">
          {{/* Google Calendar */}}
          {{ $gcalUrl := printf "https://calendar.google.com/calendar/render?action=TEMPLATE&text=%s&dates=%s/%s&details=%s&location=%s&sf=true"
            (.Title | urlquery)
            (strings.Replace .Params.date_start "-" "" | printf "%sT090000")
            (strings.Replace .Params.date_end "-" "" | printf "%sT180000")
            (.Params.description_short | default "" | urlquery)
            (.Params.venue_address | default "" | urlquery) }}
          <a href="{{ $gcalUrl }}" target="_blank" rel="noopener" class="activity-detail__cal-btn">
            + Google æ—¥æ›†
          </a>

          {{/* iCalendar ä¸‹è¼‰ */}}
          <button class="activity-detail__cal-btn" onclick="downloadICS()">
            + iCalendar
          </button>
        </div>
      </div>
    </div>

    {{/* åœ°é»å¡ç‰‡ */}}
    <div class="activity-detail__card">
      <div class="activity-detail__card-icon">ğŸ“</div>
      <div class="activity-detail__card-content">
        <h3 class="activity-detail__card-title">æ´»å‹•åœ°é»</h3>
        <p class="activity-detail__card-text">{{ .Params.venue_name }}</p>
        <p class="activity-detail__card-sub">{{ .Params.city }}, {{ .Params.country }}</p>
        {{ with .Params.venue_address }}
        <p class="activity-detail__card-address">{{ . }}</p>
        {{ end }}

        {{/* åœ°åœ–é€£çµ */}}
        {{ with .Params.venue_address }}
        {{ $encodedAddr := . | urlquery }}
        <div class="activity-detail__map-links">
          <a href="https://www.google.com/maps/search/?api=1&query={{ $encodedAddr }}" target="_blank" rel="noopener" class="activity-detail__map-btn">
            Google Map
          </a>
          <a href="https://maps.apple.com/?q={{ $encodedAddr }}" target="_blank" rel="noopener" class="activity-detail__map-btn">
            Apple Map
          </a>
          <a href="https://www.openstreetmap.org/search?query={{ $encodedAddr }}" target="_blank" rel="noopener" class="activity-detail__map-btn">
            OpenStreetMap
          </a>
        </div>
        {{ end }}
      </div>
    </div>

  </div>

  {{/* ä¸»è¾¦è³‡è¨Šèˆ‡å®˜ç¶² */}}
  <div class="activity-detail__meta">
    {{ with .Params.organizer }}
    <div class="activity-detail__meta-item">
      <strong>ä¸»è¾¦å–®ä½ï¼š</strong>
      {{ if $.Params.organizer_url }}
      <a href="{{ $.Params.organizer_url }}" target="_blank" rel="noopener">{{ . }}</a>
      {{ else }}
      {{ . }}
      {{ end }}
    </div>
    {{ end }}

    {{ with .Params.official_url }}
    <div class="activity-detail__meta-item">
      <strong>å®˜æ–¹ç¶²ç«™ï¼š</strong>
      <a href="{{ . }}" target="_blank" rel="noopener" class="activity-detail__official-link">{{ . }}</a>
    </div>
    {{ end }}
  </div>

  {{/* æ´»å‹•è©³æƒ… */}}
  {{ with .Params.description_long }}
  <div class="activity-detail__content">
    <h2 class="activity-detail__section-title">æ´»å‹•è©³æƒ…</h2>
    <div class="activity-detail__body">
      {{ . | markdownify }}
    </div>
  </div>
  {{ else }}
  {{ with .Content }}
  <div class="activity-detail__content">
    <h2 class="activity-detail__section-title">æ´»å‹•è©³æƒ…</h2>
    <div class="activity-detail__body">
      {{ . }}
    </div>
  </div>
  {{ end }}
  {{ end }}

  {{/* æ¨™ç±¤ */}}
  {{ with .Params.tags }}
  <div class="activity-detail__tags">
    {{ range . }}
    <span class="activity-detail__tag">{{ . }}</span>
    {{ end }}
  </div>
  {{ end }}

  {{/* ç›¸é—œæ´»å‹• */}}
  {{ $currentTags := .Params.tags | default slice }}
  {{ $currentRegion := .Params.region }}
  {{ $currentSlug := .Params.slug }}
  {{ $relatedActivities := slice }}

  {{ range where (where .Site.RegularPages "Section" "activities") ".Params.slug" "!=" $currentSlug }}
    {{ $matchScore := 0 }}
    {{ if eq .Params.region $currentRegion }}
      {{ $matchScore = add $matchScore 2 }}
    {{ end }}
    {{ range .Params.tags }}
      {{ if in $currentTags . }}
        {{ $matchScore = add $matchScore 1 }}
      {{ end }}
    {{ end }}
    {{ if gt $matchScore 0 }}
      {{ $relatedActivities = $relatedActivities | append . }}
    {{ end }}
  {{ end }}

  {{ if gt (len $relatedActivities) 0 }}
  <div class="activity-detail__related">
    <h2 class="activity-detail__section-title">ç›¸é—œæ´»å‹•</h2>
    <div class="activity-detail__related-grid">
      {{ range first 4 $relatedActivities }}
      {{ partial "v2/activity-card.html" (dict "activity" . "variant" "small") }}
      {{ end }}
    </div>
  </div>
  {{ end }}

</article>

{{/* Schema.org Event çµæ§‹åŒ–è³‡æ–™ */}}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Event",
  "name": "{{ .Title }}",
  "description": "{{ .Params.description_short | default .Description }}",
  "startDate": "{{ .Params.date_start }}",
  "endDate": "{{ .Params.date_end }}",
  "location": {
    "@type": "Place",
    "name": "{{ .Params.venue_name }}",
    "address": "{{ .Params.venue_address }}"
  },
  "organizer": {
    "@type": "Organization",
    "name": "{{ .Params.organizer }}",
    "url": "{{ .Params.organizer_url }}"
  },
  "url": "{{ .Params.official_url }}",
  "image": "{{ .Params.image | absURL }}"
}
</script>

{{/* iCalendar ä¸‹è¼‰åŠŸèƒ½ */}}
<script>
function downloadICS() {
  var title = {{ .Title | jsonify }};
  var dateStart = {{ .Params.date_start | jsonify }};
  var dateEnd = {{ .Params.date_end | jsonify }};
  var description = {{ .Params.description_short | default "" | jsonify }};
  var location = {{ .Params.venue_address | default "" | jsonify }};
  var url = {{ .Params.official_url | default .Permalink | jsonify }};
  var slug = {{ .Params.slug | default .File.BaseFileName | jsonify }};

  // æ ¼å¼åŒ–æ—¥æœŸç‚º iCalendar æ ¼å¼
  var startDate = dateStart.replace(/-/g, '') + 'T090000';
  var endDate = dateEnd.replace(/-/g, '') + 'T180000';
  var now = new Date().toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

  var icsContent = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//AINEXT//AI Activities//EN',
    'BEGIN:VEVENT',
    'UID:' + slug + '@ainext.tw',
    'DTSTAMP:' + now,
    'DTSTART:' + startDate,
    'DTEND:' + endDate,
    'SUMMARY:' + title,
    'DESCRIPTION:' + description.replace(/\n/g, '\\n'),
    'LOCATION:' + location,
    'URL:' + url,
    'END:VEVENT',
    'END:VCALENDAR'
  ].join('\r\n');

  var blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
  var link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = slug + '.ics';
  link.click();
}
</script>
{{ end }}
